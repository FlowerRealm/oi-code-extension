name: Docker - æŒ‰éœ€é•œåƒæ„å»º

on:
  # ===== æ‰‹åŠ¨è§¦å‘ =====
  workflow_dispatch:
    inputs:
      target_platform:
        description: 'Target Platform (ç›®æ ‡å¹³å°)'
        required: true
        default: 'linux'
        type: choice
        options:
          - linux    # ä»…Linuxå¹³å° (å¤šæ¶æ„ amd64/arm64)
          - windows  # ä»…Windowså¹³å° (amd64)
          - all      # æ‰€æœ‰å¹³å° (Linux + Windows)

  # ===== PR è¯„è®ºè§¦å‘ =====
  # å½“åœ¨PRä¸‹æ–¹å›å¤ç‰¹å®šå‘½ä»¤æ—¶è§¦å‘Dockeræ„å»º
  issue_comment:
    types: [created]

jobs:
  # ===== PRè¯„è®ºå¤„ç† =====
  pr-comment-trigger:
    if: ${{ github.event_name == 'issue_comment' && github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    outputs:
      trigger-docker: ${{ steps.check-comment.outputs.trigger }}
      docker-platform: ${{ steps.check-comment.outputs.platform }}
      pr-number: ${{ github.event.issue.number }}
      pr-branch: ${{ steps.get-pr-branch.outputs.branch }}

    steps:
      - name: ğŸ” æ£€æŸ¥PRè¯„è®ºè§¦å‘æ¡ä»¶
        id: check-comment
        run: |
          COMMENT="${{ github.event.comment.body }}"
          echo "æ”¶åˆ°PRè¯„è®º: $COMMENT"

          TRIGGER_FOUND=false
          PLATFORM="linux"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ„å»ºè§¦å‘å…³é”®è¯
          if echo "$COMMENT" | grep -q '\bdocker-push\b'; then
            TRIGGER_FOUND=true
            echo "æ£€æµ‹åˆ°Dockeræ„å»ºè§¦å‘æŒ‡ä»¤"
          fi

          # æ£€æŸ¥å¹³å°æŒ‡å®š (é»˜è®¤ä¸ºlinux)
          if echo "$COMMENT" | grep -q '\bwindows\b'; then
            PLATFORM="windows"
            echo "æŒ‡å®šWindowså¹³å°æ„å»º"
          elif echo "$COMMENT" | grep -q '\ball\b'; then
            PLATFORM="all"
            echo "æŒ‡å®šæ‰€æœ‰å¹³å°æ„å»º"
          else
            echo "ä½¿ç”¨é»˜è®¤Linuxå¹³å°"
          fi

          echo "trigger=$TRIGGER_FOUND" >> $GITHUB_OUTPUT
          echo "platform=$PLATFORM" >> $GITHUB_OUTPUT

      - name: ğŸ“‹ è·å–PRåˆ†æ”¯ä¿¡æ¯
        if: ${{ steps.check-comment.outputs.trigger == 'true' }}
        id: get-pr-branch
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number
            });
            return pr.head.ref;

      - name: âœ… ç¡®è®¤è§¦å‘æ¡ä»¶
        if: ${{ steps.check-comment.outputs.trigger == 'true' }}
        run: |
          echo "ğŸš€ Dockeræ„å»ºå·²è§¦å‘!"
          echo "ğŸ“ PR: #${{ steps.pr-comment-trigger.outputs.pr-number }}"
          echo "ğŸŒ¿ åˆ†æ”¯: ${{ steps.pr-comment-trigger.outputs.pr-branch }}"
          echo "ğŸ¯ å¹³å°: ${{ steps.check-comment.outputs.platform }}"

          # åœ¨è¿™é‡Œå¯ä»¥å‘é€é€šçŸ¥æˆ–è®°å½•è§¦å‘ä¿¡æ¯
          echo "è§¦å‘è¡¨æ ¼æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> triggered-builds.log

      - name: âŒ æ„å»ºæœªè§¦å‘
        if: ${{ steps.check-comment.outputs.trigger != 'true' }}
        run: |
          echo "â„¹ï¸  æ­¤PRè¯„è®ºä¸æ»¡è¶³Dockeræ„å»ºè§¦å‘æ¡ä»¶"
          echo "ğŸ’¡ å¯ä½¿ç”¨çš„è§¦å‘å…³é”®è¯:"
          echo "   - docker-push"
          echo "ğŸ“„ å¯é€‰å‚æ•°:"
          echo "   - platform: linux, windows, all"
          echo "ğŸ› ï¸  ç¤ºä¾‹: 'docker-push linux'"

  # ===== Dockeré•œåƒæ„å»º =====
  docker-build:
    needs: pr-comment-trigger
    if: ${{ needs.pr-comment-trigger.outputs.trigger-docker == 'true' || github.event_name == 'workflow_dispatch' }}
    name: 'Dockeré•œåƒæ„å»º'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # å¦‚æœæ˜¯é€šè¿‡PRè§¦å‘çš„ï¼Œä½¿ç”¨PRçš„åˆ†æ”¯
          ref: ${{ github.event_name == 'workflow_dispatch' && 'main' || needs.pr-comment-trigger.outputs.pr-branch }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Compile application
        run: npm run compile

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:buildx-stable-1
            network=host

      - name: Set up QEMU for cross-platform
        if: ${{ needs.pr-comment-trigger.outputs.trigger-docker == 'true' && needs.pr-comment-trigger.outputs.docker-platform == 'all' || needs.pr-comment-trigger.outputs.docker-platform == 'linux' || github.event.inputs.target_platform == 'all' || github.event.inputs.target_platform == 'linux' }}
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: flowerrealm
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Get build metadata
        id: meta
        run: |
          VERSION=$(node -p "require('./package.json').version")

          # ç¡®å®šç›®æ ‡å¹³å°
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TARGET_PLATFORM="${{ github.event.inputs.target_platform }}"
          else
            TARGET_PLATFORM="${{ needs.pr-comment-trigger.outputs.docker-platform }}"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "target_platform=$TARGET_PLATFORM" >> $GITHUB_OUTPUT
          echo "trigger_method=${{ github.event_name }}" >> $GITHUB_OUTPUT
          echo "pr_number=${{ needs.pr-comment-trigger.outputs.pr-number || github.run_number }}" >> $GITHUB_OUTPUT

      - name: ğŸ’š Build and push Linux images
        if: ${{ steps.meta.outputs.target_platform == 'all' || steps.meta.outputs.target_platform == 'linux' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            flowerrealm/oi-code-clang:latest
            flowerrealm/oi-code-clang:v${{ steps.meta.outputs.version }}
            flowerrealm/oi-code-clang:v${{ steps.meta.outputs.version }}-amd64
            flowerrealm/oi-code-clang:v${{ steps.meta.outputs.version }}-arm64
            flowerrealm/oi-code-clang:pr-${{ steps.meta.outputs.pr_number }}
          cache-from: type=registry,ref=flowerrealm/oi-code-clang:cache-amd64
          cache-to: type=registry,ref=flowerrealm/oi-code-clang:cache-amd64,mode=max
          provenance: true
          sbom: true
          labels: |
            org.opencontainers.image.title=OI-Code Clang Container
            org.opencontainers.image.description=Multi-platform Clang 18.1.8 compiler for OI competitive programming
            org.opencontainers.image.source=https://github.com/FlowerRealm/oi-code-extension
            org.opencontainers.image.licenses=MIT
            org.opencontainers.image.vendor=FlowerRealm
            org.opencontainers.image.version=${{ steps.meta.outputs.version }}
            com.flowerrealm.language=c,cpp
            com.flowerrealm.compiler=clang-18
            com.flowerrealm.build.trigger=${{ steps.meta.outputs.trigger_method }}
            com.flowerrealm.build.pr=${{ steps.meta.outputs.pr_number }}

      - name: ğŸªŸ Build and push Windows images
        if: ${{ steps.meta.outputs.target_platform == 'all' || steps.meta.outputs.target_platform == 'windows' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.windows
          platforms: windows/amd64
          push: true
          tags: |
            flowerrealm/oi-code-clang:latest-win
            flowerrealm/oi-code-clang:v${{ steps.meta.outputs.version }}-win
            flowerrealm/oi-code-clang:pr-${{ steps.meta.outputs.pr_number }}-win
          cache-from: type=registry,ref=flowerrealm/oi-code-clang:cache-win
          cache-to: type=registry,ref=flowerrealm/oi-code-clang:cache-win,mode=max
          provenance: true
          sbom: true
          labels: |
            org.opencontainers.image.title=OI-Code Clang Container Windows
            org.opencontainers.image.description=Windows Clang 18.1.8 compiler container for OI competitive programming
            org.opencontainers.image.source=https://github.com/FlowerRealm/oi-code-extension
            org.opencontainers.image.licenses=MIT
            org.opencontainers.image.vendor=FlowerRealm
            org.opencontainers.image.version=${{ steps.meta.outputs.version }}
            com.flowerrealm.language=c,cpp
            com.flowerrealm.compiler=clang-18
            com.flowerrealm.build.trigger=${{ steps.meta.outputs.trigger_method }}
            com.flowerrealm.build.pr=${{ steps.meta.outputs.pr_number }}

      - name: ğŸ“Š ç”Ÿæˆæ„å»ºæŠ¥å‘Š
        run: |
          echo "## ğŸ³ Docker é•œåƒæ„å»ºæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… æ„å»ºçŠ¶æ€: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "| å±æ€§ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬ | v${{ steps.meta.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| å¹³å° | ${{ steps.meta.outputs.target_platform }} |" >> $GITHUB_STEP_SUMMARY
          echo "| è§¦å‘æ–¹å¼ | ${{ steps.meta.outputs.trigger_method }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PRå· | #${{ steps.meta.outputs.pr_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ„å»ºæ—¶é—´ | $(date +'%Y-%m-%d %H:%M:%S') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ—ï¸ æ„å»ºè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "- Base Image: Ubuntu 24.04 LTS / Windows Server Core" >> $GITHUB_STEP_SUMMARY
          echo "- Clang Version: 18.1.8" >> $GITHUB_STEP_SUMMARY
          echo "- Build Tools: make, cmake, gdb, lldb" >> $GITHUB_STEP_SUMMARY
          echo "- Cache: Enabled with registry backend" >> $GITHUB_STEP_SUMMARY
          echo "- SBOM + Provenance: Enabled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ å‘å¸ƒé•œåƒåˆ—è¡¨" >> $GITHUB_STEP_SUMMARY
          docker images flowerrealm/oi-code-clang --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" || echo "é•œåƒåˆ—è¡¨è·å–å¤±è´¥"

      - name: ğŸ’¬ åœ¨PRä¸­å‘å¸ƒæ„å»ºç»“æœ
        if: ${{ github.event_name == 'issue_comment' && needs.pr-comment-trigger.outputs.trigger-docker == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: '${{ needs.pr-comment-trigger.outputs.pr-number }}'
            });

            const commentBody = `
            ## ğŸ³ Docker é•œåƒæ„å»ºå®Œæˆ

            âœ… **æ„å»ºæˆåŠŸï¼** Docker é•œåƒå·²å‘å¸ƒåˆ° Docker Hub

            ğŸ“Š **æ„å»ºä¿¡æ¯ï¼š**
            - ç‰ˆæœ¬: \`v${{ steps.meta.outputs.version }}\`
            - å¹³å°: \`${{ steps.meta.outputs.target_platform }}\`
            - æ„å»ºå·: \`${{ github.run_number }}\`
            - æäº¤: \`${{ github.sha }}\`

            ğŸ“¦ **å‘å¸ƒé•œåƒï¼š**
            - \`flowerrealm/oi-code-clang:latest\`
            - \`flowerrealm/oi-code-clang:v${{ steps.meta.outputs.version }}\`
            - \`flowerrealm/oi-code-clang:pr-${{ steps.meta.outputs.pr_number }}\`

            ğŸ”— **æŸ¥çœ‹è¯¦æƒ…ï¼š** [${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ---
            _æ­¤æ¶ˆæ¯ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ_
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: '${{ needs.pr-comment-trigger.outputs.pr-number }}',
              body: commentBody
            });
