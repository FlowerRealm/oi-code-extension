# Docker Rootless模式适用性分析报告

## 项目概述
OI-Code是一个面向信息学竞赛的VS Code扩展，使用Docker容器来编译和运行C/C++代码。

## 当前架构分析

### 1. 容器运行模式
- **使用方式**: 每次运行代码时创建临时容器 (`--rm`)
- **网络配置**: `--network=none` (完全隔离)
- **用户权限**: 容器内使用非特权用户 `runner`
- **资源限制**: 内存限制、CPU限制、PID限制

### 2. 安全措施
- **非特权用户**: 容器以 `runner` 用户运行，非root用户
- **只读挂载**: 源代码目录以只读方式挂载
- **网络隔离**: 完全禁用网络访问
- **资源限制**: 严格的内存和进程数限制

### 3. 文件系统访问
- **源代码**: 只读挂载 `/tmp/source:ro`
- **临时目录**: 可写挂载 `/tmp:rw`
- **工作目录**: `/sandbox` (容器内)

## Rootless模式适用性评估

### ✅ 优势分析

#### 1. 安全性增强
- **更小攻击面**: Rootless模式消除了容器逃逸到宿主机root权限的风险
- **用户级隔离**: 容器进程以普通用户身份运行，符合OI-Code的安全设计理念
- **权限分离**: 更好地与宿主机用户权限分离

#### 2. 多用户环境支持
- **非root用户**: 在共享环境中（如学校机房），不需要root权限
- **用户隔离**: 不同用户的容器完全隔离，不会互相影响
- **权限管理**: 更符合现代操作系统安全策略

#### 3. 移动开发支持
- **macOS/Windows**: Docker Desktop默认使用Rootless模式
- **开发环境**: 更好的开发体验，不需要管理员权限

### ⚠️ 挑战和限制

#### 1. 性能影响
- **启动时间**: Rootless容器启动可能稍慢
- **文件系统**: 用户命名空间可能影响I/O性能
- **网络限制**: 某些网络功能可能受限

#### 2. 兼容性问题
- **旧版本Docker**: 需要Docker 20.10+版本
- **操作系统**: Linux内核需要4.0+支持用户命名空间
- **镜像兼容性**: 某些需要特权操作的镜像可能不兼容

#### 3. 配置复杂性
- **用户命名空间**: 需要正确配置 `/etc/subuid` 和 `/etc/subgid`
- **权限映射**: 需要正确设置用户ID映射
- **系统配置**: 某些系统需要额外的配置

### 🔍 具体技术分析

#### 容器内用户权限
```bash
# 当前Dockerfile中的用户配置
USER runner
WORKDIR /sandbox
```

#### Rootless模式下的用户映射
```bash
# 宿主机用户ID映射
/etc/subuid: username:100000:65536
/etc/subgid: username:100000:65536

# 容器内用户ID
# runner (1000) -> 映射到宿主机用户命名空间
```

#### 资源限制支持
```bash
# Rootless模式支持的限制
--memory=512m        ✅ 支持
--cpus=1.0           ✅ 支持  
--pids-limit=64      ✅ 支持
--network=none       ✅ 支持
--read-only          ✅ 支持
```

## 📊 建议方案

### 方案1: 完全迁移到Rootless模式 (推荐)
**适用场景**: 新部署、教育环境、安全要求高的环境

**优点**:
- 最佳安全性
- 现代化架构
- 更好的多用户支持

**实施步骤**:
1. 更新文档说明Rootless模式要求
2. 提供Rootless模式配置指南
3. 修改安装脚本支持Rootless模式检测
4. 测试兼容性

### 方案2: 混合模式支持
**适用场景**: 需要向后兼容的环境

**优点**:
- 兼容现有系统
- 渐进式迁移
- 灵活部署

**实施步骤**:
1. 添加Rootless模式检测
2. 根据环境自动选择模式
3. 提供配置选项

### 方案3: 保持现状
**适用场景**: 稳定生产环境，无需变更

**优点**:
- 零风险
- 无需修改

**缺点**:
- 错过安全改进
- 不够现代化

## 🎯 最终建议

**推荐采用方案1: 完全迁移到Rootless模式**

理由:
1. **安全性**: OI-Code面向学生用户，安全性至关重要
2. **教育环境**: 学校机房通常禁用root权限
3. **现代化**: 符合容器技术发展趋势
4. **兼容性**: 当前的容器配置已经很好地支持Rootless模式

## 📋 实施清单

### 1. 文档更新
- [ ] 更新README说明Rootless模式要求
- [ ] 创建Rootless模式安装指南
- [ ] 更新故障排除文档

### 2. 安装脚本改进
- [ ] 添加Rootless模式检测
- [ ] 自动配置用户命名空间
- [ ] 提供Rootless模式专用安装选项

### 3. 代码改进
- [ ] 添加Rootless模式检测逻辑
- [ ] 根据模式调整容器参数
- [ ] 改进错误处理和用户提示

### 4. 测试验证
- [ ] 在Rootless环境下进行全面测试
- [ ] 验证所有功能正常工作
- [ ] 性能基准测试

## 🚀 结论

OI-Code项目非常适合采用Docker Rootless模式。项目的安全设计理念、非特权用户运行方式、以及资源限制策略都与Rootless模式的特点高度契合。迁移到Rootless模式将进一步提升项目的安全性和现代化程度。