<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OI-Code 初始化</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        html[data-theme='light'] {
            --pico-background-color: #f9f9f9;
            --pico-color: #111827;
            --pico-h1-color: #111827;
            --pico-muted-color: #6b7280;
            --pico-contrast: #1f2937;
            --pico-contrast-inverse: #ffffff;
            --pico-primary: #43a047;
            --pico-primary-inverse: #ffffff;
            --pico-card-background-color: #ffffff;
            --pico-card-border-color: #e5e7eb;
        }

        html[data-theme='dark'] {
            --pico-background-color: #1e1e1e;
            --pico-color: #d4d4d4;
            --pico-h1-color: #ffffff;
            --pico-muted-color: #a5a5a5;
            --pico-contrast: #ffffff;
            --pico-contrast-inverse: #000000;
            --pico-primary: #60a5fa;
            --pico-primary-inverse: #000000;
            --pico-card-background-color: #252526;
            --pico-card-border-color: #3c3c3c;
        }

        .hidden {
            display: none;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .stepper {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 1rem;
            color: var(--pico-muted-color);
        }

        .step.active {
            color: var(--pico-contrast);
        }

        .step-number {
            font-size: 0.8em;
            background-color: var(--pico-card-border-color);
            color: var(--pico-muted-color);
            border-radius: 50%;
            width: 2em;
            height: 2em;
            line-height: 2em;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .step.active .step-number {
            background-color: var(--pico-primary);
            color: var(--pico-primary-inverse);
        }

        .arrow {
            font-size: 2em;
            color: var(--pico-card-border-color);
        }

        .nav-buttons button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            width: fit-content;
            flex-grow: 0;
            flex-shrink: 0;
            --pico-form-element-spacing-vertical: 0.5rem;
            --pico-form-element-spacing-horizontal: 1rem;
        }
    </style>
</head>

<body>
    <main class="container">
        <header id="main-header">
            <h1>欢迎使用 OI-Code</h1>
            <p>请跟随以下步骤配置您的 OI 环境。</p>
        </header>

        <div class="stepper">
            <div id="step-indicator-0" class="step active">
                <div class="step-number">1</div><strong>选择主题</strong>
            </div>
            <div class="arrow">→</div>
            <div id="step-indicator-1" class="step">
                <div class="step-number">2</div><strong>选择语言</strong>
            </div>
            <div class="arrow">→</div>
            <div id="step-indicator-2" class="step">
                <div class="step-number">3</div><strong>选择工作区</strong>
            </div>
        </div>

        <section id="step-content">
            <div id="content-0" class="content-panel">
                <article>
                    <h2>第一步：选择一个颜色主题</h2>
                    <p>选择一个您喜欢的主题来开始编程，这会立即生效。</p>
                    <button id="select-theme-btn">打开主题选择器</button>
                </article>
            </div>
            <div id="content-1" class="content-panel hidden">
                <article>
                    <h2>第二步：选择您的常用语言</h2>
                    <div id="language-selection">
                        <p>我们会根据您的选择，为您配置编译器。</p>
                        <label for="lang-c"><input type="checkbox" id="lang-c" name="language" value="c">
                            c</label>
                        <label for="lang-cpp"><input type="checkbox" id="lang-cpp" name="language" value="cpp">
                            C++</label>

                    </div>
                    <div id="language-loading" class="hidden">
                        <p><strong>正在配置语言环境...</strong></p>
                        <p>请在 VS Code 窗口顶部的弹出框中完成操作。</p>
                    </div>
                </article>
            </div>
            <div id="content-2" class="content-panel hidden">
                <article>
                    <h2>第三步：选择工作区</h2>
                    <p>请选择一个文件夹作为您的工作区。</p>
                    <button id="select-folder-btn">选择文件夹</button>
                </article>
            </div>

        </section>

        <article id="loading-spinner" aria-busy="true" class="hidden"></article>

        <div class="nav-buttons">
            <button id="prev-btn" disabled><i data-feather="arrow-left"></i> 上一步</button>
            <button id="next-btn">下一步 <i data-feather="arrow-right"></i></button>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script>
        feather.replace();

        const vscode = acquireVsCodeApi();

        let currentStep = 0;
        const contentPanels = document.querySelectorAll('.content-panel');
        const stepIndicators = document.querySelectorAll('.step');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        const mainHeader = document.getElementById('main-header');
        const loadingSpinner = document.getElementById('loading-spinner');
        const stepContent = document.getElementById('step-content');
        const navButtons = document.querySelector('.nav-buttons');
        const stepper = document.querySelector('.stepper');

        const languageSelectionDiv = document.getElementById('language-selection');
        const languageLoadingDiv = document.getElementById('language-loading');



        function getSelectedLanguages() {
            const selected = [];
            const cCheckbox = document.getElementById('lang-c');
            const cppCheckbox = document.getElementById('lang-cpp');

            if (cCheckbox && cCheckbox.checked) selected.push('c');
            if (cppCheckbox && cppCheckbox.checked) selected.push('cpp');

            return selected;
        }

        function updateUI() {
            stepIndicators.forEach((indicator, index) => indicator.classList.toggle('active', index === currentStep));
            contentPanels.forEach((panel, index) => panel.classList.toggle('hidden', index !== currentStep));

            prevBtn.disabled = currentStep === 0;
            nextBtn.disabled = false;

            if (currentStep === 1 && getSelectedLanguages().length === 0) {
                nextBtn.disabled = true;
            }

            if (currentStep === 2) { // Workspace
                nextBtn.innerHTML = `完成 <i data-feather="check"></i>`;
            } else {
                nextBtn.innerHTML = `下一步 <i data-feather="arrow-right"></i>`;
            }
            feather.replace();
        }

        const langCCheckbox = document.getElementById('lang-c');
        const langCppCheckbox = document.getElementById('lang-cpp');
        if (langCCheckbox) langCCheckbox.addEventListener('change', updateUI);
        if (langCppCheckbox) langCppCheckbox.addEventListener('change', updateUI);


        prevBtn.addEventListener('click', () => {
            if (currentStep > 0) {
                currentStep--;
                updateUI();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentStep === 2) {
                vscode.postMessage({ command: 'initialize' });
                mainHeader.classList.add('hidden');
                stepContent.classList.add('hidden');
                navButtons.classList.add('hidden');
                stepper.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
            } else if (currentStep === 1) {  // 语言选择步骤
                const selectedLanguages = getSelectedLanguages();
                if (selectedLanguages.length > 0) {
                    languageSelectionDiv.classList.add('hidden');
                    languageLoadingDiv.classList.remove('hidden');
                    vscode.postMessage({
                        command: 'configure-languages',
                        languages: selectedLanguages
                    });
                }
            } else if (currentStep < 2) {
                currentStep++;
                updateUI();
            }
        });

        document.getElementById('select-theme-btn').addEventListener('click', () => vscode.postMessage({ command: 'select-theme' }));
        document.getElementById('select-folder-btn').addEventListener('click', () => vscode.postMessage({ command: 'select-folder' }));

        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.command) {
                case 'set-theme':
                    document.documentElement.setAttribute('data-theme', message.theme);
                    break;
                case 'go-to-step':
                    currentStep = message.step;

                    languageLoadingDiv.classList.add('hidden');
                    updateUI();
                    break;

            }
        });

        updateUI();
        vscode.postMessage({ command: 'get-theme' });
    </script>
</body>

</html>
