name: OI-Code Multi-Platform Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - linux
          - windows
          - test

jobs:
  # ç†è§£é¡¹ç›®å’Œä»£ç æ£€æŸ¥
  analyze:
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') }}
    runs-on: ubuntu-latest
    outputs:
      changed-files: ${{ steps.files.outputs.all_changed_files }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "all_changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | tr '\n' ' ')" >> $GITHUB_OUTPUT
          else
            echo "all_changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | tr '\n' ' ')" >> $GITHUB_OUTPUT
          fi

      - name: Get version
        id: version
        run: |
          if [ -f package.json ]; then
            VERSION=$(node -p "require('./package.json').version")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "version=0.0.1" >> $GITHUB_OUTPUT
          fi

  # æ„å»ºLinuxé•œåƒ
  build-linux:
    needs: analyze
    if: |
      contains(needs.analyze.outputs.changed-files, 'Dockerfile') ||
      github.event_name == 'workflow_dispatch' ||
      needs.analyze.outputs.version != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [amd64, arm64]
    environment: ${{ inputs.environment || 'development' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup QEMU (for cross-platform)
        if: matrix.platform == 'arm64'
        uses: docker/setup-qemu-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: flowerrealm
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: flowerrealm/oi-code-clang
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=raw,value={{branch}}-{{sha}}-{{date 'YYYYMMDD'}}
            type=raw,value={{branch}}-linux-${{ matrix.platform }}
            type=raw,value=v${{ needs.analyze.outputs.version }}-linux-${{ matrix.platform }}

      - name: Build and push Linux image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/${{ matrix.platform }}
          file: Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=flowerrealm/oi-code-clang:cache
          cache-to: type=registry,ref=flowerrealm/oi-code-clang:cache,mode=max

  # æ„å»ºWindowsé•œåƒ
  build-windows:
    needs: analyze
    if: |
      contains(needs.analyze.outputs.changed-files, 'Dockerfile.windows') ||
      github.event_name == 'workflow_dispatch' ||
      needs.analyze.outputs.version != ''
    runs-on: windows-latest
    environment: ${{ inputs.environment || 'development' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: flowerrealm
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: flowerrealm/oi-code-clang
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=raw,value={{branch}}-{{sha}}-windows-amd64
            type=raw,value={{branch}}-windows-amd64
            type=raw,value=v${{ needs.analyze.outputs.version }}-windows-amd64

      - name: Build and push Windows image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: windows/amd64
          file: Dockerfile.windows
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=flowerrealm/oi-code-clang:cache-windows
          cache-to: type=registry,ref=flowerrealm/oi-code-clang:cache-windows,mode=max

  # åˆ›å»ºmulti-arch manifest
  create-manifest:
    needs: [build-linux, build-windows]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: flowerrealm
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Create multi-arch manifest
        run: |
          VERSION="${{ needs.analyze.outputs.version }}"
          BRANCH="${{ github.ref_name }}"

          # ä¸ºmainåˆ†æ”¯åˆ›å»ºlatestæ ‡ç­¾
          docker buildx imagetools create --tag flowerrealm/oi-code-clang:latest \
            flowerrealm/oi-code-clang:"${BRANCH}"-linux-amd64 \
            flowerrealm/oi-code-clang:"${BRANCH}"-linux-arm64 \
            flowerrealm/oi-code-clang:"${BRANCH}"-windows-amd64

          # ä¸ºç‰¹å®šç‰ˆæœ¬åˆ›å»ºæ ‡ç­¾
          if [ "$VERSION" ]; then
            docker buildx imagetools create --tag flowerrealm/oi-code-clang:"v${VERSION}" \
              flowerrealm/oi-code-clang:"${BRANCH}"-linux-amd64 \
              flowerrealm/oi-code-clang:"${BRANCH}"-linux-arm64 \
              flowerrealm/oi-code-clang:"${BRANCH}"-windows-amd64
          fi

  # æµ‹è¯•æ„å»ºçš„é•œåƒ
  test-builds:
    needs: create-manifest
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [amd64, arm64]
        os: [linux, windows]
        exclude:
          # åªåœ¨QEMUå¯ç”¨æ—¶æµ‹è¯•ARM64
          - platform: arm64
            os: windows
    environment: production
    steps:
      - name: Test Linux images
        if: matrix.os == 'linux'
        run: |
          echo "Testing Linux ${{ matrix.platform }} image..."
          docker run --rm --platform linux/${{ matrix.platform }} \
            flowerrealm/oi-code-clang:latest \
            clang --version || exit 1

          docker run --rm --platform linux/${{ matrix.platform }} \
            flowerrealm/oi-code-clang:latest \
            clang++ --version || exit 1

      - name: Test Windows images
        if: matrix.os == 'windows' && matrix.platform == 'amd64'
        run: |
          echo "Testing Windows amd64 image..."
          docker run --rm --platform windows/amd64 \
            flowerrealm/oi-code-clang:latest \
            cmd /C "echo Windows Clang Environment Ready" || exit 1

  # æ„å»ºå’Œæµ‹è¯•VS Codeæ‰©å±•
  build-extension:
    needs: analyze
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run compile

      - name: Lint and format
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-linux
          path: test-output.log

  # ç”Ÿæˆå‘å¸ƒè¯´æ˜
  release-notes:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [create-manifest, test-builds, build-extension]
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ needs.analyze.outputs.version }}"
          BRANCH="${{ github.ref_name }}"

          cat << EOF > release_body.txt
          ## ğŸš€ OI-Code Extension v${VERSION}

          ### ğŸ³ æ–°å¢çš„ Docker é•œåƒ

          **å¤šå¹³å°é•œåƒæ„å»ºå®Œæˆ:**
          - Linux AMD64/ARM64: \`flowerrealm/oi-code-clang:latest\`
          - Windows AMD64: \`flowerrealm/oi-code-clang:latest\`
          - æ¶æ„æ ‡ç­¾: \`v${VERSION}\`, \`latest\`

          ### ğŸ—ï¸ æ„å»ºç‰¹æ€§

          - **è·¨å¹³å°æ”¯æŒ**: Linux/AMD64, Linux/ARM64, Windows/AMD64
          - **ç¼“å­˜ä¼˜åŒ–**: æ„å»ºç¼“å­˜æ˜¾è‘—åŠ é€Ÿ CI/CD æµç¨‹
          - **å®‰å…¨æ€§**: éç‰¹æƒç”¨æˆ·è¿è¡Œï¼Œå¥åº·æ£€æŸ¥é›†æˆ
          - **æœ€å°åŒ–è®¾è®¡**: ç§»é™¤ä¸å¿…è¦çš„è°ƒè¯•å·¥å…·ï¼Œä¼˜åŒ–é•œåƒå¤§å°

          ### ğŸ”§ æŠ€æœ¯æ ˆ

          - **ç¼–è¯‘å™¨**: Clang 18.1.8 with libc++
          - **ç«èµ›åº“**: Boost, GMP, MPFR
          - **ç³»ç»Ÿåº“**: GCC å…¼å®¹æ€§, æ ‡å‡†åº«
          - **è¿è¡Œæ—¶**: Ubuntu 24.04 LTS åŸºç¡€

          ### ğŸ¯ ä½¿ç”¨æ–¹æ³•

          \`\`\`bash
          # Linux ç¯å¢ƒä½¿ç”¨
          docker run --rm flowerrealm/oi-code-clang:latest clang++ -std=c++17 solution.cpp -o solution

          # Windows ç¯å¢ƒä½¿ç”¨
          docker run -it --rm flowerrealm/oi-code-clang:latest cmd
          \`\`\`

          ### ğŸ” é•œåƒè¯¦æƒ…

          é•œåƒå·²é€šè¿‡å¤šå¹³å°å…¼å®¹æ€§æµ‹è¯•ï¼ŒåŒ…å«ï¼š
          - å®Œæ•´çš„ç«èµ›ç¼–ç¨‹å·¥å…·é“¾
          - æ”¯æŒ C++11/14/17/20 æ ‡å‡†
          - ç«èµ›ä¸“ç”¨æ•°æ®ç»“æ„åº“
          - é«˜ç²¾åº¦ç®—æ³•åº“æ”¯æŒ

          ---
          ğŸŒŸ **æ„å»ºä¿¡æ¯**ï¼š
          - åˆ†æ”¯: \`${BRANCH}\`
          - æäº¤: \`${{ github.sha }}\`
          - ä½œè€…: @${{ github.actor }}
          - æ—¶é—´: $(date -Iseconds)
          EOF

          cat release_body.txt >> $GITHUB_STEP_SUMMARY
          echo "notes_file=release_body.txt" >> $GITHUB_OUTPUT

      - name: Create Release (if applicable)
        if: startsWith(github.event.head_commit.message, 'Bump version')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.analyze.outputs.version }}
          release_name: OI-Code Extension v${{ needs.analyze.outputs.version }}
          body_path: release_body.txt
          draft: false
          prerelease: false

  # æ¸…ç†æ„å»ºç¼“å­˜
  cleanup:
    if: always()
    needs: [create-manifest, test-builds, build-extension, release-notes]
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Clean up registry
        if: github.event_name == 'schedule'
        run: |
          echo "å®šæœŸæ¸…ç†è€é•œåƒæ ‡ç­¾..."
          # ä¿ç•™æœ€è¿‘5ä¸ªç‰ˆæœ¬
          docker run --rm luraproject/lura \
            flowerrealm/oi-code-clang \
            --max-tags 5 \
            --dry-run
